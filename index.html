<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tra c·ª©u ph√¢n c√¥ng</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f8fafc; padding:24px; color:#111; }
  h1 { text-align:center; margin-bottom:16px; }
  input, button { font-size:16px; padding:8px 12px; }
  button { cursor:pointer; border:none; border-radius:6px; background:#2563eb; color:#fff; }
  button:hover { background:#1d4ed8; }
  #card { margin-top:16px; background:#fff; border-radius:10px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
  #noiDung { margin-top:6px; white-space:pre-wrap; background:#fdfdfd; border:1px solid #e5e7eb; border-radius:8px; padding:10px;}
  #names { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
  label { background:#f1f5f9; padding:4px 8px; border-radius:6px; display:inline-flex; align-items:center; gap:6px; }
  label.red { color:#dc2626; font-weight:700; background:#fee2e2; }
  #note { color:#6b7280; font-size:13px; margin-top:8px;}
  #log { text-align:center; font-size:13px; color:#555; margin-top:12px;}
</style>
</head>
<body>
  <h1>Tra c·ª©u ph√¢n c√¥ng</h1>

  <div style="text-align:center;">
    <input id="soVu" type="text" placeholder="Nh·∫≠p s·ªë v·ª•‚Ä¶"/>
    <button onclick="traCuu()">üîç Tra c·ª©u</button>
    <button onclick="boiDo()">üü• Ho√†n th√†nh</button>
    <button onclick="boBoido()">üßπ X√≥a</button>
  </div>

  <div id="card">
    <div><b>S·ªë v·ª•:</b> <span id="showSoVu">‚Äì</span></div>
    <div style="margin-top:6px;"><b>N·ªôi dung (m√†u th·∫≠t):</b>
      <div id="noiDung">‚Äì</div>
    </div>
    <div id="names"></div>
    <div id="note"></div>
  </div>

  <div id="log"></div>

<script>
/** üîó Thay b·∫±ng URL /exec m·ªõi nh·∫•t c·ªßa b·∫°n */
const URL = "https://script.google.com/macros/s/AKfycbzJyJXoS21jGTI0hyLmOVr7GNfskFp--QwJhddkl2oAipRC-go44t2JyRx0Ea664ngU/exec";

/** Danh s√°ch t√™n chu·∫©n ƒë·ªÉ d√≤ trong n·ªôi dung */
const CANBO = ["Nghƒ©a","Th·ªßy","ƒê·∫°t","Tr∆∞·ªùng","Th·ªëng","K·ª≥ Anh","Thao","Ti·∫øn","Huy","Nam","PNam","T√¨nh","Qu√¢n","L∆∞·ª£ng","Ph√∫c","Khang","D≈©ng","Nh·∫≠t","S√°ng","Khoa","B√¨nh","Tu·∫•n","H·∫£i","Tu√¢n","Trung","Duy"];

/** ‚îÄ‚îÄ Helpers robust cho JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function getJSON(url) {
  const r = await fetch(url);
  const j = await r.json();
  // n·∫øu backend tr·∫£ d·∫°ng [ {...} ]
  if (Array.isArray(j)) return j[0] || {};
  return j;
}
async function postJSON(url, payload) {
  const r = await fetch(url, { method: "POST", body: JSON.stringify(payload) });
  const j = await r.json();
  return Array.isArray(j) ? (j[0] || {}) : j;
}
/** Tr√≠ch m·∫£ng t·ª´ {data:[‚Ä¶]} ho·∫∑c tr·∫£ [] */
function pickArray(resp) {
  if (Array.isArray(resp)) return resp;
  if (resp && Array.isArray(resp.data)) return resp.data;
  return [];
}

/** ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentSoVu = "";
let lastRawText = "";

/** ‚îÄ‚îÄ Render checkbox ch·ªâ t√™n c√≥ trong raw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderCheckboxes(foundNames, coloredNames) {
  const wrap = document.getElementById("names");
  const note = document.getElementById("note");
  wrap.innerHTML = "";
  note.textContent = "";

  if (!foundNames.length) {
    note.textContent = "‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán t√™n c√°n b·ªô n√†o trong n·ªôi dung.";
    return;
  }

  foundNames.forEach(name => {
    const checked = coloredNames.includes(name);
    const label = document.createElement("label");
    if (checked) label.classList.add("red");
    label.innerHTML = `<input type="checkbox" name="cb" value="${name}" ${checked ? "checked":""}> ${name}`;
    wrap.appendChild(label);
  });
}

/** ‚îÄ‚îÄ Tra c·ª©u ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function traCuu() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nh·∫≠p s·ªë v·ª•!");
  currentSoVu = soVu;
  document.getElementById("showSoVu").textContent = soVu;
  document.getElementById("noiDung").textContent = "ƒêang t·∫£i‚Ä¶";
  document.getElementById("names").innerHTML = "";
  document.getElementById("note").textContent = "";
  document.getElementById("log").textContent = "";

  try {
    // 1) L·∫•y text g·ªëc ƒë·ªÉ L·ªåC t√™n
    const info = await getJSON(`${URL}?action=getPhanCongBySoVu&soVu=${encodeURIComponent(soVu)}`);
    if (!info || info.found === false) {
      document.getElementById("noiDung").textContent = "(Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu)";
      return;
    }
    lastRawText = (info.raw || "").toString();

    // 2) L·∫•y HTML RichText c√≥ m√†u th·∫≠t
    const rich = await getJSON(`${URL}?action=getRichHTML&soVu=${encodeURIComponent(soVu)}`);
    document.getElementById("noiDung").innerHTML = rich && rich.html ? rich.html : "(Kh√¥ng c√≥ d·ªØ li·ªáu)";

    // 3) L·∫•y danh s√°ch ƒë√£ b√¥i ƒë·ªè
    const coloredResp = await getJSON(`${URL}?action=getColored&soVu=${encodeURIComponent(soVu)}`);
    const coloredArr = pickArray(coloredResp);

    // 4) L·ªçc danh s√°ch t√™n ch·ªâ nh·ªØng t√™n c√≥ xu·∫•t hi·ªán trong raw
    const rawLower = lastRawText.toLowerCase();
    const foundNames = CANBO.filter(n => rawLower.includes(n.toLowerCase()));

    // 5) Render checkbox
    renderCheckboxes(foundNames, coloredArr);

    document.getElementById("log").textContent = "ƒê√£ t·∫£i xong.";
  } catch (e) {
    document.getElementById("noiDung").textContent = "(L·ªói khi t·∫£i d·ªØ li·ªáu)";
    document.getElementById("log").textContent = "L·ªói: " + e.message;
  }
}

/** ‚îÄ‚îÄ G·ª≠i b√¥i ƒë·ªè / b·ªè b√¥i ƒë·ªè ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function boiDo() {
  if (!currentSoVu) return alert("H√£y tra c·ª©u tr∆∞·ªõc!");
  const selected = [...document.querySelectorAll("input[name='cb']:checked")].map(x => x.value);
  if (!selected.length) return alert("Ch∆∞a ch·ªçn t√™n ƒë·ªÉ b√¥i ƒë·ªè!");

  try {
    const res = await postJSON(URL, { action: "applyHighlight", soVu: currentSoVu, selectedNames: selected, user: "WebApp" });
    document.getElementById("log").textContent = res.message || "ƒê√£ b√¥i ƒë·ªè.";
    await traCuu(); // refresh preview + checkbox
  } catch (e) {
    document.getElementById("log").textContent = "L·ªói b√¥i ƒë·ªè: " + e.message;
  }
}

async function boBoido() {
  if (!currentSoVu) return alert("H√£y tra c·ª©u tr∆∞·ªõc!");
  try {
    const res = await postJSON(URL, { action: "clearHighlight", soVu: currentSoVu, user: "WebApp" });
    document.getElementById("log").textContent = res.message || "ƒê√£ b·ªè b√¥i ƒë·ªè.";
    await traCuu(); // refresh preview + checkbox
  } catch (e) {
    document.getElementById("log").textContent = "L·ªói b·ªè b√¥i ƒë·ªè: " + e.message;
  }
}
</script>
</body>
</html>
