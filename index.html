<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tra c·ª©u ph√¢n c√¥ng ‚Äì ƒê·ªôi Kh√°m nghi·ªám hi·ªán tr∆∞·ªùng</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f8fafc; padding:24px; color:#111; }
  h1 { text-align:center; margin-bottom:20px; }
  input, button { font-size:16px; padding:8px 12px; }
  button { cursor:pointer; border:none; border-radius:6px; background:#2563eb; color:#fff; transition:background 0.2s; }
  button:hover { background:#1d4ed8; }
  #card { margin-top:16px; background:#fff; border-radius:10px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
  #noiDung { margin-top:6px; white-space:pre-wrap; background:#fdfdfd; border:1px solid #e5e7eb; border-radius:8px; padding:10px; min-height:80px; }
  #names { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
  label { background:#f1f5f9; padding:4px 8px; border-radius:6px; display:inline-flex; align-items:center; gap:6px; }
  label.red { color:#dc2626; font-weight:700; background:#fee2e2; }
  #note { color:#6b7280; font-size:13px; margin-top:8px;}
  #log { text-align:center; font-size:13px; color:#555; margin-top:12px;}
  .bottom-buttons { text-align:center; margin-top:20px; }
  .bottom-buttons button { margin:0 6px; }
</style>
</head>
<body>
  <h1>Tra c·ª©u Ph√¢n c√¥ng c√¥ng vi·ªác</h1>

  <!-- Ph·∫ßn nh·∫≠p s·ªë v·ª• v√† tra c·ª©u -->
  <div style="text-align:center;">
    <input id="soVu" type="text" placeholder="Nh·∫≠p s·ªë v·ª•‚Ä¶" />
    <button onclick="traCuu()">üîç Tra c·ª©u</button>
  </div>

  <!-- K·∫øt qu·∫£ hi·ªÉn th·ªã -->
  <div id="card">
    <div><b>S·ªë v·ª•:</b> <span id="showSoVu">‚Äì</span></div>

    <div style="margin-top:6px;">
      <b>Ph√¢n c√¥ng c√¥ng vi·ªác c·ª• th·ªÉ:</b>
      <div id="noiDung">‚Äì</div>
    </div>

    <div id="names"></div>
    <div id="note"></div>

    <!-- Hai n√∫t h√†nh ƒë·ªông ƒë∆∞·ª£c ƒë∆∞a xu·ªëng d∆∞·ªõi -->
    <div class="bottom-buttons">
      <button onclick="boiDo()">üü• B√¥i ƒë·ªè</button>
      <button onclick="boBoido()">üßπ B·ªè b√¥i ƒë·ªè</button>
    </div>
  </div>

  <div id="log"></div>

<script>
/** üîó Link Web App c·ªßa b·∫°n */
const URL = "https://script.google.com/macros/s/AKfycbyyAzuSzZUCB7fDQ_0EpIvG-V0IZj2a2ph9fws3g_zj01hEQhQwbHkJjzJ0Bq2ZiC0q/exec";

/** Danh s√°ch c√°n b·ªô chu·∫©n */
const CANBO = ["Nghƒ©a","Th·ªßy","ƒê·∫°t","Tr∆∞·ªùng","Th·ªëng","K·ª≥ Anh","Thao","Ti·∫øn","Huy","Nam","PNam","T√¨nh","Qu√¢n","L∆∞·ª£ng","Ph√∫c","Khang","D≈©ng","Nh·∫≠t","S√°ng","Khoa","B√¨nh","Tu·∫•n","H·∫£i","Tu√¢n","Trung","Duy"];

async function getJSON(url) {
  const r = await fetch(url);
  const j = await r.json();
  return Array.isArray(j) ? (j[0] || {}) : j;
}

function pickArray(resp) {
  if (Array.isArray(resp)) return resp;
  if (resp && Array.isArray(resp.data)) return resp.data;
  return [];
}

let currentSoVu = "";
let lastRawText = "";

function renderCheckboxes(foundNames, coloredNames) {
  const wrap = document.getElementById("names");
  const note = document.getElementById("note");
  wrap.innerHTML = "";
  note.textContent = "";

  if (!foundNames.length) {
    note.textContent = "‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán t√™n c√°n b·ªô n√†o trong n·ªôi dung.";
    return;
  }

  foundNames.forEach(name => {
    const checked = coloredNames.includes(name);
    const label = document.createElement("label");
    if (checked) label.classList.add("red");
    label.innerHTML = `<input type="checkbox" name="cb" value="${name}" ${checked ? "checked":""}> ${name}`;
    wrap.appendChild(label);
  });
}

async function traCuu() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nh·∫≠p s·ªë v·ª•!");
  currentSoVu = soVu;
  document.getElementById("showSoVu").textContent = soVu;
  document.getElementById("noiDung").textContent = "ƒêang t·∫£i...";
  document.getElementById("names").innerHTML = "";
  document.getElementById("note").textContent = "";
  document.getElementById("log").textContent = "";

  try {
    const info = await getJSON(`${URL}?action=getPhanCongBySoVu&soVu=${encodeURIComponent(soVu)}`);
    if (!info || info.found === false) {
      document.getElementById("noiDung").textContent = "(Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu)";
      return;
    }
    lastRawText = (info.raw || "").toString();

    const rich = await getJSON(`${URL}?action=getRichHTML&soVu=${encodeURIComponent(soVu)}`);
    document.getElementById("noiDung").innerHTML = rich && rich.html ? rich.html : "(Kh√¥ng c√≥ d·ªØ li·ªáu)";

    const coloredResp = await getJSON(`${URL}?action=getColored&soVu=${encodeURIComponent(soVu)}`);
    const coloredArr = pickArray(coloredResp);

    const rawLower = lastRawText.toLowerCase();
    const foundNames = CANBO.filter(n => rawLower.includes(n.toLowerCase()));
    renderCheckboxes(foundNames, coloredArr);

    document.getElementById("log").textContent = "ƒê√£ t·∫£i xong.";
  } catch (e) {
    document.getElementById("noiDung").textContent = "(L·ªói khi t·∫£i d·ªØ li·ªáu)";
    document.getElementById("log").textContent = "L·ªói: " + e.message;
  }
}

async function boiDo() {
  if (!currentSoVu) return alert("H√£y tra c·ª©u tr∆∞·ªõc!");
  const selected = [...document.querySelectorAll("input[name='cb']:checked")].map(x => x.value);
  if (!selected.length) return alert("Ch∆∞a ch·ªçn t√™n ƒë·ªÉ b√¥i ƒë·ªè!");

  try {
    const url = `${URL}?action=applyHighlight&soVu=${encodeURIComponent(currentSoVu)}&selectedNames=${encodeURIComponent(JSON.stringify(selected))}&user=WebApp`;
    const res = await getJSON(url);
    document.getElementById("log").textContent = res.message || "ƒê√£ b√¥i ƒë·ªè.";
    await traCuu();
  } catch (e) {
    document.getElementById("log").textContent = "L·ªói b√¥i ƒë·ªè: " + e.message;
  }
}

async function boBoido() {
  if (!currentSoVu) return alert("H√£y tra c·ª©u tr∆∞·ªõc!");
  try {
    const url = `${URL}?action=clearHighlight&soVu=${encodeURIComponent(currentSoVu)}&user=WebApp`;
    const res = await getJSON(url);
    document.getElementById("log").textContent = res.message || "ƒê√£ b·ªè b√¥i ƒë·ªè.";
    await traCuu();
  } catch (e) {
    document.getElementById("log").textContent = "L·ªói b·ªè b√¥i ƒë·ªè: " + e.message;
  }
}
</script>
</body>
</html>