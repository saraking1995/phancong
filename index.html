<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u ph√¢n c√¥ng ‚Äì ƒê·ªôi Kh√°m nghi·ªám hi·ªán tr∆∞·ªùng</title>
<style>
  body { font-family: system-ui, sans-serif; background: #f8fafc; padding: 24px; color: #111; }
  h1 { text-align: center; margin-bottom: 20px; }
  input, button { font-size: 16px; padding: 8px 12px; }
  button { cursor: pointer; border: none; border-radius: 6px; background: #2563eb; color: white; }
  button:hover { background: #1d4ed8; }
  #result { margin-top: 16px; padding: 16px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px #ccc; }
  #names { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
  label { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
  label.red { color: #dc2626; font-weight: bold; background: #fee2e2; }
  #noiDung { margin-top: 4px; white-space: pre-wrap; background: #fdfdfd; border-radius: 8px; padding: 10px; border: 1px solid #e5e7eb; }
  #log { font-size: 13px; color: #555; margin-top: 16px; text-align: center; }
</style>
</head>
<body>
<h1>Tra c·ª©u Ph√¢n c√¥ng c√¥ng vi·ªác</h1>

<div style="text-align:center;">
  <input type="text" id="soVu" placeholder="Nh·∫≠p s·ªë v·ª•..." />
  <button onclick="traCuu()">üîç Tra c·ª©u</button>
  <button onclick="boiDo()">üü• B√¥i ƒë·ªè</button>
  <button onclick="boBoido()">üßπ B·ªè b√¥i ƒë·ªè</button>
</div>

<div id="result">
  <div><b>S·ªë v·ª•:</b> <span id="showSoVu">‚Äì</span></div>
  <div style="margin-top:6px;">
    <b>N·ªôi dung (hi·ªÉn th·ªã m√†u th·∫≠t):</b>
    <div id="noiDung">‚Äì</div>
  </div>
  <div id="names"></div>
</div>

<div id="log"></div>

<script>
/* Thay URL n√†y b·∫±ng link Web App c·ªßa b·∫°n */
const URL = "https://script.google.com/macros/s/AKfycbzJyJXoS21jGTI0hyLmOVr7GNfskFp--QwJhddkl2oAipRC-go44t2JyRx0Ea664ngU/exec";
const DANH_SACH = ["Nghƒ©a","Th·ªßy","ƒê·∫°t","Tr∆∞·ªùng","Th·ªëng","K·ª≥ Anh","Thao","Ti·∫øn","Huy","Nam","PNam","T√¨nh","Qu√¢n","L∆∞·ª£ng","Ph√∫c","Khang","D≈©ng","Nh·∫≠t","S√°ng","Khoa","B√¨nh","Tu·∫•n","H·∫£i","Tu√¢n","Trung","Duy"];

async function traCuu() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nh·∫≠p s·ªë v·ª•!");
  document.getElementById("showSoVu").innerText = soVu;
  document.getElementById("noiDung").innerText = "ƒêang t·∫£i...";

  try {
    // 1Ô∏è‚É£ L·∫•y n·ªôi dung RichText HTML (c√≥ m√†u)
    const htmlRes = await fetch(`${URL}?action=getRichHTML&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    document.getElementById("noiDung").innerHTML = htmlRes.html || "(Kh√¥ng c√≥ d·ªØ li·ªáu)";

    // 2Ô∏è‚É£ L·∫•y danh s√°ch t√™n ƒë√£ b√¥i ƒë·ªè
    const coloredResp = await fetch(`${URL}?action=getColored&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    const coloredArr = Array.isArray(coloredResp.data) ? coloredResp.data : [];

    // 3Ô∏è‚É£ Sinh danh s√°ch tick
    const container = document.getElementById("names");
    container.innerHTML = "";
    DANH_SACH.forEach(name => {
      const isRed = coloredArr.includes(name);
      const label = document.createElement("label");
      if (isRed) label.classList.add("red");
      label.innerHTML = `<input type="checkbox" name="cb" value="${name}" ${isRed?'checked':''}> ${name}`;
      container.appendChild(label);
    });

    document.getElementById("log").innerText = `ƒê√£ t·∫£i th√¥ng tin s·ªë v·ª• ${soVu}.`;
  } catch (e) {
    alert("L·ªói khi tra c·ª©u: " + e.message);
  }
}

async function boiDo() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nh·∫≠p s·ªë v·ª•!");
  const selected = [...document.querySelectorAll("input[name='cb']:checked")].map(cb=>cb.value);
  if (!selected.length) return alert("Ch∆∞a ch·ªçn t√™n!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"applyHighlight", soVu, selectedNames: selected })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "ƒê√£ b√¥i ƒë·ªè.";
    await traCuu(); // c·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i m·ªõi
  } catch (e) { alert("L·ªói b√¥i ƒë·ªè: " + e.message); }
}

async function boBoido() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nh·∫≠p s·ªë v·ª•!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"clearHighlight", soVu })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "ƒê√£ b·ªè b√¥i ƒë·ªè.";
    await traCuu(); // c·∫≠p nh·∫≠t l·∫°i
  } catch (e) { alert("L·ªói b·ªè b√¥i ƒë·ªè: " + e.message); }
}
</script>
</body>
</html>
