<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cá»©u PhÃ¢n cÃ´ng â€“ Äá»™i KhÃ¡m nghiá»‡m hiá»‡n trÆ°á»ng</title>
<style>
  body { font-family: system-ui, sans-serif; background: #f8fafc; padding: 24px; color: #111; }
  h1 { text-align: center; margin-bottom: 20px; }
  input, button { font-size: 16px; padding: 8px 12px; }
  button { cursor: pointer; border: none; border-radius: 6px; background: #2563eb; color: white; }
  button:hover { background: #1d4ed8; }
  #result { margin-top: 16px; padding: 16px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px #ccc; }
  #names { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
  label { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
  label.red { color: #dc2626; font-weight: bold; background: #fee2e2; }
  #log { font-size: 13px; color: #555; margin-top: 16px; }
</style>
</head>
<body>
<h1>Tra cá»©u PhÃ¢n cÃ´ng cÃ´ng viá»‡c</h1>

<div style="text-align:center;">
  <input type="text" id="soVu" placeholder="Nháº­p sá»‘ vá»¥..." />
  <button onclick="traCuu()">ğŸ” Tra cá»©u</button>
  <button onclick="boiDo()">ğŸŸ¥ BÃ´i Ä‘á»</button>
  <button onclick="boBoido()">ğŸ§¹ Bá» bÃ´i Ä‘á»</button>
</div>

<div id="result">
  <div><b>Sá»‘ vá»¥:</b> <span id="showSoVu">â€“</span></div>
  <div style="margin-top:6px;"><b>Ná»™i dung:</b> <span id="noiDung">â€“</span></div>
  <div id="names"></div>
</div>

<div id="log"></div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzJyJXoS21jGTI0hyLmOVr7GNfskFp--QwJhddkl2oAipRC-go44t2JyRx0Ea664ngU/exec";
const DANH_SACH = ["NghÄ©a","Thá»§y","Äáº¡t","TrÆ°á»ng","Thá»‘ng","Ká»³ Anh","Thao","Tiáº¿n","Huy","Nam","PNam","TÃ¬nh","QuÃ¢n","LÆ°á»£ng","PhÃºc","Khang","DÅ©ng","Nháº­t","SÃ¡ng","Khoa","BÃ¬nh","Tuáº¥n","Háº£i","TuÃ¢n","Trung","Duy"];

async function traCuu() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nháº­p sá»‘ vá»¥!");
  document.getElementById("showSoVu").innerText = soVu;
  document.getElementById("noiDung").innerText = "Äang táº£i...";

  try {
    // 1ï¸âƒ£ Láº¥y ná»™i dung phÃ¢n cÃ´ng
    const res = await fetch(`${URL}?action=getPhanCongBySoVu&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    if (!res.found) return alert("KhÃ´ng tÃ¬m tháº¥y sá»‘ vá»¥!");

    document.getElementById("noiDung").innerText = res.raw || "(Trá»‘ng)";
    
    // 2ï¸âƒ£ Láº¥y danh sÃ¡ch tÃªn Ä‘Ã£ bÃ´i Ä‘á»
    const coloredResp = await fetch(`${URL}?action=getColored&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    const coloredArr = Array.isArray(coloredResp.data) ? coloredResp.data : [];

    // 3ï¸âƒ£ Sinh danh sÃ¡ch tick
    const container = document.getElementById("names");
    container.innerHTML = "";
    DANH_SACH.forEach(name => {
      const isRed = coloredArr.includes(name);
      const label = document.createElement("label");
      if (isRed) label.classList.add("red");
      label.innerHTML = `<input type="checkbox" name="cb" value="${name}" ${isRed?'checked':''}> ${name}`;
      container.appendChild(label);
    });

    document.getElementById("log").innerText = `ÄÃ£ táº£i thÃ´ng tin sá»‘ vá»¥ ${soVu}.`;
  } catch (e) {
    alert("Lá»—i khi tra cá»©u: " + e.message);
  }
}

async function boiDo() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nháº­p sá»‘ vá»¥!");
  const selected = [...document.querySelectorAll("input[name='cb']:checked")].map(cb=>cb.value);
  if (!selected.length) return alert("ChÆ°a chá»n tÃªn!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"applyHighlight", soVu, selectedNames: selected })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "ÄÃ£ bÃ´i Ä‘á».";
    traCuu(); // cáº­p nháº­t láº¡i tráº¡ng thÃ¡i má»›i
  } catch (e) { alert("Lá»—i bÃ´i Ä‘á»: " + e.message); }
}

async function boBoido() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nháº­p sá»‘ vá»¥!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"clearHighlight", soVu })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "ÄÃ£ bá» bÃ´i Ä‘á».";
    traCuu(); // cáº­p nháº­t láº¡i
  } catch (e) { alert("Lá»—i bá» bÃ´i Ä‘á»: " + e.message); }
}
</script>
</body>
</html>
