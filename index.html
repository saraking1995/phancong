<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cứu Phân công – Đội Khám nghiệm hiện trường</title>
<style>
  body { font-family: system-ui, sans-serif; background: #f8fafc; padding: 24px; color: #111; }
  h1 { text-align: center; margin-bottom: 20px; }
  input, button { font-size: 16px; padding: 8px 12px; }
  button { cursor: pointer; border: none; border-radius: 6px; background: #2563eb; color: white; }
  button:hover { background: #1d4ed8; }
  #result { margin-top: 16px; padding: 16px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px #ccc; }
  #names { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
  label { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
  label.red { color: #dc2626; font-weight: bold; background: #fee2e2; }
  #log { font-size: 13px; color: #555; margin-top: 16px; }
</style>
</head>
<body>
<h1>Tra cứu Phân công công việc</h1>

<div style="text-align:center;">
  <input type="text" id="soVu" placeholder="Nhập số vụ..." />
  <button onclick="traCuu()">🔍 Tra cứu</button>
  <button onclick="boiDo()">🟥 Bôi đỏ</button>
  <button onclick="boBoido()">🧹 Bỏ bôi đỏ</button>
</div>

<div id="result">
  <div><b>Số vụ:</b> <span id="showSoVu">–</span></div>
  <div style="margin-top:6px;"><b>Nội dung:</b> <span id="noiDung">–</span></div>
  <div id="names"></div>
</div>

<div id="log"></div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzJyJXoS21jGTI0hyLmOVr7GNfskFp--QwJhddkl2oAipRC-go44t2JyRx0Ea664ngU/exec";
const DANH_SACH = ["Nghĩa","Thủy","Đạt","Trường","Thống","Kỳ Anh","Thao","Tiến","Huy","Nam","PNam","Tình","Quân","Lượng","Phúc","Khang","Dũng","Nhật","Sáng","Khoa","Bình","Tuấn","Hải","Tuân","Trung","Duy"];

async function traCuu() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nhập số vụ!");
  document.getElementById("showSoVu").innerText = soVu;
  document.getElementById("noiDung").innerText = "Đang tải...";

  try {
    // 1️⃣ Lấy nội dung phân công
    const res = await fetch(`${URL}?action=getPhanCongBySoVu&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    if (!res.found) return alert("Không tìm thấy số vụ!");

    document.getElementById("noiDung").innerText = res.raw || "(Trống)";
    
    // 2️⃣ Lấy danh sách tên đã bôi đỏ
    const coloredResp = await fetch(`${URL}?action=getColored&soVu=${encodeURIComponent(soVu)}`).then(r=>r.json());
    const coloredArr = Array.isArray(coloredResp.data) ? coloredResp.data : [];

    // 3️⃣ Sinh danh sách tick
    const container = document.getElementById("names");
    container.innerHTML = "";
    DANH_SACH.forEach(name => {
      const isRed = coloredArr.includes(name);
      const label = document.createElement("label");
      if (isRed) label.classList.add("red");
      label.innerHTML = `<input type="checkbox" name="cb" value="${name}" ${isRed?'checked':''}> ${name}`;
      container.appendChild(label);
    });

    document.getElementById("log").innerText = `Đã tải thông tin số vụ ${soVu}.`;
  } catch (e) {
    alert("Lỗi khi tra cứu: " + e.message);
  }
}

async function boiDo() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nhập số vụ!");
  const selected = [...document.querySelectorAll("input[name='cb']:checked")].map(cb=>cb.value);
  if (!selected.length) return alert("Chưa chọn tên!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"applyHighlight", soVu, selectedNames: selected })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "Đã bôi đỏ.";
    traCuu(); // cập nhật lại trạng thái mới
  } catch (e) { alert("Lỗi bôi đỏ: " + e.message); }
}

async function boBoido() {
  const soVu = document.getElementById("soVu").value.trim();
  if (!soVu) return alert("Nhập số vụ!");
  try {
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({ action:"clearHighlight", soVu })
    }).then(r=>r.json());
    document.getElementById("log").innerText = res.message || "Đã bỏ bôi đỏ.";
    traCuu(); // cập nhật lại
  } catch (e) { alert("Lỗi bỏ bôi đỏ: " + e.message); }
}
</script>
</body>
</html>
